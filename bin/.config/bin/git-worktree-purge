#!/usr/bin/env bash

set -e

# Function to find the bare repository (.git directory)
find_git_dir() {
  local current_dir="$1"
  while [[ "$current_dir" != "/" ]]; do
    # Check if current directory is a .git directory (bare)
    if [[ "$current_dir" == *.git ]] && [[ -d "$current_dir" ]]; then
      echo "$current_dir"
      return 0
    fi
    # Check if there is a .git directory inside
    local found=$(find "$current_dir" -maxdepth 2 -name "*.git" -type d | head -n 1)
    if [[ -n "$found" ]]; then
      echo "$found"
      return 0
    fi
    current_dir=$(dirname "$current_dir")
  done
  return 1
}

GIT_DIR=$(find_git_dir "$(pwd)")

if [[ -z "$GIT_DIR" ]]; then
  echo "Error: Could not find a .git directory."
  exit 1
fi

# Check if it's a bare repository by looking for worktrees directory
if [[ ! -d "$GIT_DIR/worktrees" ]]; then
  echo "Error: This does not appear to be a bare repository with worktrees."
  exit 1
fi

PARENT_DIR=$(dirname "$GIT_DIR")
REPO_NAME=$(basename "$PARENT_DIR")

# Get the default branch
DEFAULT_BRANCH=$(git -C "$GIT_DIR" symbolic-ref --short HEAD 2>/dev/null || git -C "$GIT_DIR" rev-parse --abbrev-ref HEAD)

# Get current worktree path
CURRENT_WORKTREE=$(git rev-parse --show-toplevel 2>/dev/null || echo "")

# Get branches that have been merged into the default branch
MERGED_BRANCHES=$(git -C "$GIT_DIR" branch --format='%(refname:short)' --merged "$DEFAULT_BRANCH")

# List worktrees, excluding the current one and the default branch
# Format: path [branch]
WORKTREES=$(git -C "$GIT_DIR" worktree list --porcelain | grep "^worktree " | cut -d' ' -f2-)

for wt in $WORKTREES; do
  # Skip if it's the current worktree
  if [[ "$wt" == "$CURRENT_WORKTREE" ]]; then
    continue
  fi

  # Skip if it's the bare repository itself
  if [[ "$wt" == *.git ]]; then
    continue
  fi

  # Get branch name for this worktree
  wt_branch=$(git -C "$GIT_DIR" worktree list | grep "^$wt " | sed 's/.*\[\([^]]*\)\].*/\1/')

  if [[ "$wt_branch" == *"bare"* ]]; then
    continue
  fi

  # If sed didn't find brackets, try awk as fallback
  if [[ -z "$wt_branch" ]] || [[ "$wt_branch" == "$wt"* ]]; then
    wt_branch=$(git -C "$GIT_DIR" worktree list | grep "^$wt " | awk '{for(i=3;i<=NF;i++) printf "%s%s", $i, (i<NF?" ":"");}' | tr -d '[]')
  fi

  # Skip if it's the default branch
  if [[ "$wt_branch" == "$DEFAULT_BRANCH" ]]; then
    continue
  fi

  # Check if the branch is in the merged branches list
  is_merged=0
  for mb in $MERGED_BRANCHES; do
    if [[ "$mb" == "$wt_branch" ]]; then
      is_merged=1
      break
    fi
  done

  if [[ $is_merged -eq 1 ]]; then
    rel_path=$(basename "$wt")
    path="$PARENT_DIR/$rel_path"

    echo "Purging merged worktree $rel_path (branch: $wt_branch) at $path..."

    # Remove tmux session if it exists
    if [[ -n "$TMUX" ]] && [[ -n "$wt_branch" ]]; then
      ORG_DIR=$(dirname "$PARENT_DIR")
      ORG_NAME=$(basename "$ORG_DIR")
      SESSION_NAME=$(echo "${ORG_NAME}/${REPO_NAME}@${wt_branch}" | tr ' .' '__')
      if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        echo "Killing tmux session '$SESSION_NAME'..."
        tmux kill-session -t "$SESSION_NAME"
      fi
    fi

    # Remove the worktree
    echo "Removing worktree $rel_path..."
    git -C "$GIT_DIR" worktree remove --force "$path"
    
    # Delete the branch since it's merged
    echo "Deleting merged branch $wt_branch..."
    git -C "$GIT_DIR" branch -d "$wt_branch" 2>/dev/null || true
  fi
done

echo "Purge complete."