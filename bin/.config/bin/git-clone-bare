#!/bin/sh

set -e

ROOT_DIR="${HOME}/workspace"

repo="$1"

if [ -z "$repo" ]; then
  echo "Error: A repository to clone must be provided" >&2
  exit 1
fi

# Automatically assume github.com if only <org>/<repo> is provided
case "$repo" in
*://* | *@*) ;;
*/*)
  echo "Assuming GitHub repository: https://github.com/${repo}.git"
  repo="https://github.com/${repo}.git"
  ;;
esac

# Extract the repository name from the URL or use the second argument
if [ -n "$2" ]; then
  repo_name="$2"
else
  repo_name=$(echo "$repo" | sed 's/.*\///; s/\.git$//')
fi

if [ -z "$repo_name" ]; then
  echo "Error: Could not determine repository name from: $repo" >&2
  exit 1
fi

target_parent="${ROOT_DIR}/${repo_name}"
target_git_dir="${target_parent}/${repo_name}.git"

# Create the parent directory if it doesn't exist
mkdir -p "$target_parent"

echo "Cloning $repo into $target_git_dir..."
git clone --bare "$repo" "$target_git_dir"

# Determine the default branch
# For a bare clone, HEAD points to the default branch
default_branch=$(git -C "$target_git_dir" symbolic-ref --short HEAD)

if [ -z "$default_branch" ]; then
  # Fallback if symbolic-ref fails
  default_branch=$(git -C "$target_git_dir" rev-parse --abbrev-ref HEAD)
fi

echo "Default branch is: $default_branch"

# Check out the default branch as a worktree sibling to the .git directory
worktree_path="${target_parent}/${default_branch}"

echo "Adding worktree for $default_branch at $worktree_path..."
git -C "$target_git_dir" worktree add "$worktree_path" "$default_branch"

echo "Successfully cloned and set up worktree."
